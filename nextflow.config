// =======================================================
// Nextflow configuration file for MTAG pairwise pipeline
// Supports: local, dsi (Docker), imperial (Singularity)
// =======================================================

params {
    // ---- Pipeline inputs ----
    samples      = "samples.csv"    // CSV file with inflammation + brain GWAS pairs
    outdir       = "results"        // Output directory
    mtag_script  = "mtag.py"        // Path to mtag.py (override in run command)

    // ---- MTAG column names ----
    snp          = "SNP"
    a1           = "A1"
    a2           = "A2"
    z            = "Z"
    n            = "N"

    // ---- Filters ----
    maf_min      = 0.01
}

// =======================================================
// PROFILES
// =======================================================

profiles {

    // ---------------------------------------------------
    // Local execution (laptop, workstation)
    // ---------------------------------------------------
    local {
        process {
            executor = 'local'
            cpus = 1
            memory = '4 GB'
            time = { 1.h * task.attempt }
            errorStrategy = 'finish'
        }
        docker.enabled = false
        singularity.enabled = false
    }

    // ---------------------------------------------------
    // Docker profile for container-based local execution
    // ---------------------------------------------------
    dsi {
        docker.enabled = true
        process {
            executor = 'local'
            cpus = 2
            memory = '8 GB'
            time = { 2.h * task.attempt }
            errorStrategy = 'retry'
            maxRetries = 2
        }
    }

    // ---------------------------------------------------
    // Imperial College London HPC profile (Singularity)
    // ---------------------------------------------------
    imperial {

        docker.enabled = false

        singularity {
            enabled = true
            autoMounts = true
        }

        process {

            // Default cluster executor
            executor = 'pbspro'

            errorStrategy = 'retry'
            maxRetries = 5
            maxErrors = '-1'

            cpus = { 1 * task.attempt }
            memory = { 6.GB * task.attempt }
            time = { 4.h * task.attempt }

            // Resource presets
            withLabel:process_single {
                cpus = 1
                memory = { 6.GB * task.attempt }
                time = { 4.h * task.attempt }
            }
            withLabel:process_low {
                cpus = { 2 * task.attempt }
                memory = { 12.GB * task.attempt }
                time = { 2.h * task.attempt }
            }
            withLabel:process_medium {
                cpus = { 8 * task.attempt }
                memory = { 32.GB * task.attempt }
                time = { 8.h * task.attempt }
            }
            withLabel:process_high {
                cpus = { 16 * task.attempt }
                memory = { 64.GB * task.attempt }
                time = { 24.h * task.attempt }
            }

            // Examples from scQC workflows
            withLabel:process_dropletqc {
                cpus = 30; memory = '80.GB'; time = '2.h'
            }
            withLabel:process_seurat {
                cpus = 10; memory = '80.GB'; time = '2.h'
            }
            withLabel:process_reports {
                cpus = 8; memory = '20.GB'; time = '1.h'
            }
        }
    }
}
